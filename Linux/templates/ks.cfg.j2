#version=RHEL9

# ==================================================
# Configuración de instalación
# ==================================================
cdrom
lang en_US.UTF-8
keyboard --vckeymap=latam --xlayouts='latam'

# ==================================================
# Manejo de Máscara de Red (Jinja2)
# ==================================================
{% set cidr = (vm_mask | string) %}
{% set netmask_map = {
  '8'  : '255.0.0.0',
  '16' : '255.255.0.0',
  '24' : '255.255.255.0',
  '25' : '255.255.255.128',
  '26' : '255.255.255.192',
  '27' : '255.255.255.224',
  '28' : '255.255.255.240',
  '29' : '255.255.255.248',
  '30' : '255.255.255.252'
} %}
{% set netmask = netmask_map.get(cidr, vm_mask) %}

# ==================================================
# Configuración de Red
# ==================================================
network --bootproto=static --ip={{ vm_ip }} --netmask={{ netmask }} --gateway={{ vm_gateway }} --nameserver={{ vm_dns1 }}{% if vm_dns2 %},{{ vm_dns2 }}{% endif %} --device=link --activate --hostname={{ vm_name }}

# ==================================================
# Configuración Regional y Seguridad
# ==================================================
timezone America/Mexico_City --utc
rootpw --plaintext {{ root_password }}
selinux --permissive
firewall --enabled --service=ssh
services --enabled=sshd

# ==================================================
# Particionado de Disco
# ==================================================
clearpart --all --initlabel --disklabel=gpt
bootloader --location=mbr --boot-drive=sda

# /boot/efi : 512 MB
part /boot/efi --fstype=efi --size=512 --ondisk=sda

# /boot : 1 GB
part /boot --fstype=xfs --size=1024 --ondisk=sda

# Volumen físico LVM
part pv.01 --grow --size=1 --ondisk=sda

volgroup vg_system pv.01

logvol / --vgname=vg_system --name=lv_root --size=20480 --fstype=xfs
logvol /home --vgname=vg_system --name=lv_home --size=51200 --fstype=xfs
logvol swap --vgname=vg_system --name=lv_swap --recommended

# ==================================================
# Usuario
# ==================================================
reboot
user --name={{ linux_user }} --password={{ linux_password }} --plaintext --groups=wheel

# ==================================================
# Paquetes
# ==================================================
%packages
@core
@development
vim
curl
wget
net-tools
bash-completion
nfs-utils
git
dnf-utils
dnf-plugins-core
-podman
-buildah
%end

# ==================================================
# Post-instalación
# ==================================================
%post --log=/root/ks-post.log

echo "=== Inicio Post-Configuración: $(date) ==="

# Asegurar sshd instalado
dnf -y install openssh-server >> /root/ks-post.log 2>&1 || true

# Habilitar SSH root login con contraseña
sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# En %post (chroot): NO arrancar ni reiniciar servicios, solo habilitar
systemctl enable sshd.service >> /root/ks-post.log 2>&1 || true

# Repo Docker
dnf -y install dnf-plugins-core >> /root/ks-post.log 2>&1 || true
dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo >> /root/ks-post.log 2>&1 || true

# Instalación Docker
dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin --nobest >> /root/ks-post.log 2>&1 || true

# Habilitar Docker (para primer arranque)
systemctl enable docker.service >> /root/ks-post.log 2>&1 || true

# Permisos de usuario
if id "{{ linux_user }}" &>/dev/null; then
  usermod -aG docker "{{ linux_user }}" >> /root/ks-post.log 2>&1 || true
else
  echo "ERROR: Usuario {{ linux_user }} no existe" >> /root/ks-post.log
fi

echo "Hostname: $(hostname)" >> /root/ks-post.log
echo "=== Fin Post-Configuración: $(date) ===" >> /root/ks-post.log

%end
