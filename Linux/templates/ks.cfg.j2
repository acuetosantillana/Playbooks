#version=RHEL9
# Configuración de instalación
cdrom
lang en_US.UTF-8
keyboard --vckeymap=us --xlayouts='us'

# Manejo de Máscara de Red (Jinja2)
{% set cidr = (vm_mask | string) %}
{% set netmask_map = {
  '8':'255.0.0.0',
  '16':'255.255.0.0',
  '24':'255.255.255.0',
  '25':'255.255.255.128',
  '26':'255.255.255.192',
  '27':'255.255.255.224',
  '28':'255.255.255.240',
  '29':'255.255.255.248',
  '30':'255.255.255.252'
} %}
{% set netmask = netmask_map.get(cidr, vm_mask) %}

# Configuración de Red
network --bootproto=static --ip={{ vm_ip }} --netmask={{ netmask }} --gateway={{ vm_gateway }} --nameserver={{ vm_dns1 }}{% if vm_dns2 %},{{ vm_dns2 }}{% endif %} --device=link --activate --hostname={{ vm_name }}

# Configuración Regional y Seguridad
timezone America/Mexico_City --utc
rootpw --plaintext {{ root_password }}
selinux --permissive
firewall --enabled --service=ssh
services --enabled=sshd

# Particionado de Disco
clearpart --all --initlabel --disklabel=gpt
bootloader --location=mbr --boot-drive=sda

part /boot/efi --fstype=efi --size=512 --ondisk=sda
part /boot --fstype=xfs --size=1024 --ondisk=sda
part pv.01 --grow --size=1 --ondisk=sda

volgroup vg_system pv.01
logvol / --vgname=vg_system --size=20480 --name=lv_root --fstype=xfs
logvol /home --vgname=vg_system --size=51200 --name=lv_home --fstype=xfs
logvol swap --vgname=vg_system --recommended --name=lv_swap

# Usuarios y Post-instalación
reboot
user --name={{ linux_user }} --password={{ linux_password }} --plaintext --groups=wheel

%packages
@core
@development
vim
curl
wget
net-tools
bash-completion
nfs-utils
git
dnf-utils
dnf-plugins-core
# Excluimos podman para evitar conflictos con Docker Engine
-podman
-buildah
%end

%post --log=/root/ks-post.log
# Nota: %post a veces corre en /bin/sh; evitamos "pipefail" para no romper.
set -eu
(set -o pipefail) 2>/dev/null || true

echo "=== Iniciando Post-Configuración - $(date) ==="
echo "SHELL=${SHELL:-unknown}" || true
readlink -f /proc/$$/exe || true

# 1. Configuración SSH SIN tocar /etc/ssh/sshd_config (Rocky/RHEL 9)
echo "Configurando SSH..."
mkdir -p /etc/ssh/sshd_config.d

cat > /etc/ssh/sshd_config.d/99-kickstart.conf <<'EOF'
PermitRootLogin yes
PasswordAuthentication yes
EOF

systemctl enable --now sshd >> /root/ks-post.log 2>&1
systemctl restart sshd >> /root/ks-post.log 2>&1 || true

# Log de verificación SSH efectivo
{
  echo "=== SSHD efectivo (sshd -T) ==="
  sshd -T | egrep 'permitrootlogin|passwordauthentication' || true
} >> /root/ks-post.log 2>&1

# 2. Configuración de Repositorio Docker
echo "Configurando repositorio de Docker..."
dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo >> /root/ks-post.log 2>&1

# 3. Instalación de Docker Engine
echo "Instalando paquetes de Docker..."
dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin --nobest >> /root/ks-post.log 2>&1

# 4. Habilitar y arrancar Docker
echo "Habilitando servicio Docker..."
systemctl enable --now docker >> /root/ks-post.log 2>&1

# 5. Permisos de usuario
echo "Configurando permisos para {{ linux_user }}..."
if id "{{ linux_user }}" >/dev/null 2>&1; then
    usermod -aG docker "{{ linux_user }}" >> /root/ks-post.log 2>&1
else
    echo "ERROR: El usuario {{ linux_user }} no existe todavía." >> /root/ks-post.log
fi

# 6. Verificación final
{
  echo "=== Resumen de Instalación ==="
  echo "Hostname: $(hostname)"
  echo "Docker Version:"
  docker --version || true
  echo "=== Finalizado correctamente - $(date) ==="
} >> /root/ks-post.log 2>&1

%end
