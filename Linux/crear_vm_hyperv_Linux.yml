#version=RHEL9
# Kickstart para Rocky Linux 9.6 (Server + GPT + LVM manual)

cdrom

# Idioma y teclado English
lang en_US.UTF-8
keyboard us

# ---------------------------------------------------------------
# Calcular máscara si vm_mask viene como "24"
# ---------------------------------------------------------------
{% set cidr = (vm_mask | string) %}
{% set netmask_map = {
  '8':'255.0.0.0',
  '16':'255.255.0.0',
  '24':'255.255.255.0',
  '25':'255.255.255.128',
  '26':'255.255.255.192',
  '27':'255.255.255.224',
  '28':'255.255.255.240',
  '29':'255.255.255.248',
  '30':'255.255.255.252'
} %}
{% set netmask = netmask_map.get(cidr, vm_mask) %}

# ---------------------------------------------------------------
# Red estática con DNS1 + DNS2 y hostname = nombre de la VM
# ---------------------------------------------------------------
network --bootproto=static \
        --ip={{ vm_ip }} \
        --netmask={{ netmask }} \
        --gateway={{ vm_gateway }} \
        --nameserver={{ vm_dns1 }}{% if vm_dns2 %},{{ vm_dns2 }}{% endif %} \
        --device=link \
        --activate \
        --hostname={{ vm_name }}

# Zona horaria México
timezone America/Mexico_City --utc

# Password de root
rootpw --plaintext {{ root_password }}

# Seguridad
selinux --permissive
firewall --enabled --service=ssh
services --enabled="sshd"

# ---------------------------------------------------------------
# Particionado GPT + LVM
# ---------------------------------------------------------------
clearpart --all --initlabel --disklabel=gpt

# EFI 512 MiB
part /boot/efi --fstype=efi --size=512 --ondisk=sda

# /boot 1 GiB
part /boot --fstype=xfs --size=1024 --ondisk=sda

# PV para LVM (resto del disco)
part pv.01 --grow --size=1 --ondisk=sda

volgroup vg_system pv.01

# / 20 GiB
logvol / --vgname=vg_system --size=20480 --name=lv_root --fstype=xfs

# /home 50 GiB
logvol /home --vgname=vg_system --size=51200 --name=lv_home --fstype=xfs

# swap recomendado
logvol swap --vgname=vg_system --recommended --name=lv_swap

reboot

# ---------------------------------------------------------------
# Usuario adicional (adm)
# ---------------------------------------------------------------
user --name={{ linux_user }} --password={{ linux_password }} --plaintext --groups=wheel

# ---------------------------------------------------------------
# Paquetes (server sin GUI + dev tools + NFS + contenedores)
# ---------------------------------------------------------------
%packages
@core
@development
vim
curl
wget
net-tools
bash-completion
nfs-utils
git
podman
%end

# ---------------------------------------------------------------
# Post-install
# ---------------------------------------------------------------
%post
echo "Instalación automática Rocky 9.6 OK" > /root/post.log

# Habilitar SSH root login con contraseña
sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

systemctl enable sshd
systemctl restart sshd

echo "SSH root enabled" >> /root/post.log
%end
