<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend"
          xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <!-- ============================= -->
    <!-- PASS 1: windowsPE             -->
    <!-- ============================= -->
    <settings pass="windowsPE">
        <component name="Microsoft-Windows-Setup"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <!-- Partitioning UEFI -->
            <DiskConfiguration>
                <Disk wcm:action="add">
                    <DiskID>0</DiskID>
                    <WillWipeDisk>true</WillWipeDisk>

                    <!-- Required partitions -->
                    <CreatePartitions>

                        <!-- EFI -->
                        <CreatePartition wcm:action="add">
                            <Order>1</Order>
                            <Type>EFI</Type>
                            <Size>100</Size>
                        </CreatePartition>

                        <!-- MSR -->
                        <CreatePartition wcm:action="add">
                            <Order>2</Order>
                            <Type>MSR</Type>
                            <Size>16</Size>
                        </CreatePartition>

                        <!-- Windows -->
                        <CreatePartition wcm:action="add">
                            <Order>3</Order>
                            <Type>Primary</Type>
                            <Extend>true</Extend>
                        </CreatePartition>

                    </CreatePartitions>

                    <ModifyPartitions>

                        <!-- EFI -->
                        <ModifyPartition wcm:action="add">
                            <Order>1</Order>
                            <PartitionID>1</PartitionID>
                            <Format>FAT32</Format>
                            <Label>System</Label>
                        </ModifyPartition>

                        <!-- Windows -->
                        <ModifyPartition wcm:action="add">
                            <Order>2</Order>
                            <PartitionID>3</PartitionID>
                            <Format>NTFS</Format>
                            <Label>Windows</Label>
                            <Letter>C</Letter>
                        </ModifyPartition>

                    </ModifyPartitions>
                </DiskConfiguration>

                <!-- Install index -->
                <ImageInstall>
                    <OSImage>
                        <InstallFrom>
                            <MetaData wcm:action="add">
                                <Key>/IMAGE/INDEX</Key>
                                <Value>4</Value>
                            </MetaData>
                        </InstallFrom>
                        <InstallTo>
                            <DiskID>0</DiskID>
                            <PartitionID>3</PartitionID>
                        </InstallTo>
                        <WillShowUI>Never</WillShowUI>
                    </OSImage>
                </ImageInstall>

                <UserData>
                    <AcceptEula>true</AcceptEula>
                    <FullName>Administrator</FullName>
                    <Organization>Company</Organization>
                </UserData>

        </component>
    </settings>

    <!-- ============================= -->
    <!-- PASS 2: specialize            -->
    <!-- ============================= -->
    <settings pass="specialize">

        <!-- Hostname -->
        <component name="Microsoft-Windows-Shell-Setup"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">
            <ComputerName>{{ vm_name }}</ComputerName>
        </component>

        <!-- STATIC IP -->
        <component name="Microsoft-Windows-TCPIP"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <Interfaces>
                <Interface wcm:action="add">

                    <Identifier>Ethernet</Identifier>

                    <Ipv4Settings>
                        <DhcpEnabled>false</DhcpEnabled>
                    </Ipv4Settings>

                    <!-- IP Address (without prefix) -->
                    <UnicastIpAddresses>
                        <IpAddress wcm:action="add" wcm:keyValue="1">
                            {{ vm_ip }}
                        </IpAddress>
                    </UnicastIpAddresses>

                    <!-- Subnet mask -->
                    <SubnetMask>{{ vm_mask }}</SubnetMask>

                    <!-- Gateway -->
                    <Routes>
                        <Route wcm:action="add">
                            <Identifier>1</Identifier>
                            <Prefix>0.0.0.0/0</Prefix>
                            <NextHopAddress>{{ vm_gateway }}</NextHopAddress>
                        </Route>
                    </Routes>

                </Interface>
            </Interfaces>
        </component>

        <!-- DNS -->
        <component name="Microsoft-Windows-DNS-Client"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <Interfaces>
                <Interface wcm:action="add">
                    <Identifier>Ethernet</Identifier>
                    <DNSServerSearchOrder>
                        <IpAddress wcm:action="add" wcm:keyValue="1">{{ vm_dns1 }}</IpAddress>
                        <IpAddress wcm:action="add" wcm:keyValue="2">{{ vm_dns2 }}</IpAddress>
                    </DNSServerSearchOrder>
                </Interface>
            </Interfaces>

        </component>

    </settings>

    <!-- ============================= -->
    <!-- PASS 3: oobeSystem + autologin -->
    <!-- ============================= -->
    <settings pass="oobeSystem">
        <component name="Microsoft-Windows-Shell-Setup"
                   processorArchitecture="amd64"
                   publicKeyToken="31bf3856ad364e35"
                   language="neutral"
                   versionScope="nonSxS">

            <!-- Local admin -->
            <UserAccounts>
                <AdministratorPassword>
                    <Value>{{ admin_password }}</Value>
                    <PlainText>true</PlainText>
                </AdministratorPassword>
            </UserAccounts>

            <!-- Auto-login  -->
            <AutoLogon>
                <Username>Administrator</Username>
                <Password>
                    <Value>{{ admin_password }}</Value>
                    <PlainText>true</PlainText>
                </Password>
                <Enabled>true</Enabled>
                <LogonCount>1</LogonCount>
            </AutoLogon>

            <OOBE>
                <HideEULAPage>true</HideEULAPage>
                <SkipUserOOBE>true</SkipUserOOBE>
                <SkipMachineOOBE>true</SkipMachineOOBE>
            </OOBE>

        </component>
    </settings>

</unattend>
